#!/usr/bin/env python
 
"""
power_inout - Plugin to graph P1 ISKRA meters
 
by Eelco Bel <eelco.bel@netforce-is.nl>, placed into the public domain
 
"""
 
import sys, subprocess
 
# config
if len(sys.argv) > 1:
 if sys.argv[1] == "config":
   print """graph_title PowerUsage ISKRA Smart Meter
graph_category Power
graph_vlabel Kw from Grid (-) / Kw to Grid (+)
graph_scale no
CurrentIn.label Power from grid (kW)
CurrentIn.type LINE2
CurrentOut.label Power to grid (kW)
CurrentOut.draw LINE2 """

## Remove """ above and uncomment this block to enable
#CurrentGen.label Power Generated by PV system (kW)
#CurrentGen.min 0
#CurrentGen.max 4
#CurrentOut.warning 0:8  """
   sys.exit(0)
 else:
     sys.stderr.write("Unknown argument %s\n" % sys.argv[1])
     sys.exit(0)
 
# fetch

## P1uitlezen.py from http://gejanssen.com/howto/Slimme-meter-uitlezen/index.html
## 
#output = subprocess.check_output(("python /usr/scripts/P1uitlezen.py"),shell=False) 
output = subprocess.check_output(("cat","/usr/share/munin/plugins/eelco_kaal.txt"), shell=False)
output = output.split('\n')
data = {}
for p1value in output[8:-10]:
 name = p1value[:9].strip('.').strip()
 value = p1value[9:].strip('(').strip('*kW)')
 data[name] = value
 
print "CurrentIn.value", data["1-0:1.7.0"].split()[0]

## Print returned power as negative value for graphing.
print "CurrentOut.value", '-' + data["1-0:2.7.0"].split()[0]
#print "CurrentOut.value", data["1-0:2.7.0"].split()[0]
 
sys.exit(0)

# This is the data we parse from the P1 reader script

exampleOutput="""
/ISk5\2MT382-1003

0-0:96.1.1(5A424556303035303839323238333132)
1-0:1.8.1(00187.665*kWh)
1-0:1.8.2(00171.936*kWh)
1-0:2.8.1(00186.880*kWh)
1-0:2.8.2(00497.634*kWh)
0-0:96.14.0(0002)
1-0:1.7.0(0000.43*kW)
1-0:2.7.0(0000.00*kW)
0-0:17.0.0(0999.00*kW)
0-0:96.3.10(1)
0-0:96.13.1()
0-0:96.13.0()
0-1:24.1.0(3)
0-1:96.1.0(3238313031353431313032353830343132)
0-1:24.3.0(131202200000)(00)(60)(1)(0-1:24.2.1)(m3)
(00834.030)
0-1:24.4.0(1)
~          
"""
